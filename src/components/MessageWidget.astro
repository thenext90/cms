---
import { MessageCircle, X, Phone, Mail } from 'lucide-astro';
---

<!-- Widget flotante "Dejar un Mensaje" -->
<div id="message-widget" class="fixed right-4 bottom-4 z-50">
  <!-- Botón flotante -->
  <button id="message-button" type="button" class="bg-accent-800 hover:bg-accent-900 text-white p-4 rounded-full shadow-xl hover:shadow-2xl transition-all duration-300 cursor-pointer group focus:outline-none focus:ring-2 focus:ring-accent-600">
    <MessageCircle size="24" class="group-hover:scale-110 transition-transform" />
  </button>
  
  <!-- Panel expandido - más ancho en desktop -->
  <div id="message-panel" class="hidden absolute right-0 bottom-full mb-4 w-96 max-w-[85vw] bg-white rounded-xl shadow-2xl border border-gray-200 overflow-hidden max-h-[60vh] overflow-y-auto">
    <!-- Header más compacto -->
    <div class="bg-gradient-to-r from-accent-800 to-accent-900 text-white p-3 relative">
      <h3 class="font-bold text-base flex items-center space-x-2">
        <MessageCircle size="18" />
        <span>Déjanos un Mensaje</span>
      </h3>
      <button id="close-panel" type="button" class="absolute top-3 right-3 text-white hover:text-orange-200 transition-colors focus:outline-none">
        <X size="16" />
      </button>
    </div>
    
    <!-- Content más compacto -->
    <div class="p-4">
      <form id="message-form" class="space-y-3">
        <div>
          <label for="msg-name" class="block text-xs font-medium text-gray-700 mb-1">Nombre</label>
          <input type="text" id="msg-name" name="name" required class="w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-accent-800 focus:border-transparent text-sm">
        </div>
        
        <div>
          <label for="msg-email" class="block text-xs font-medium text-gray-700 mb-1">Email</label>
          <input type="email" id="msg-email" name="email" required class="w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-accent-800 focus:border-transparent text-sm">
        </div>
        
        <div>
          <label for="msg-message" class="block text-xs font-medium text-gray-700 mb-1">Mensaje</label>
          <textarea id="msg-message" name="message" rows="2" required class="w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-accent-800 focus:border-transparent resize-none text-sm"></textarea>
        </div>
        
        <button type="submit" class="w-full bg-accent-800 hover:bg-accent-900 text-white py-2 px-4 rounded-md transition-colors font-semibold text-sm">
          Enviar Mensaje
        </button>
      </form>
      
      <!-- Quick contact options más compactos -->
      <div class="mt-4 pt-3 border-t border-gray-200">
        <p class="text-xs text-gray-600 mb-2">También puedes contactarnos:</p>
        <div class="space-y-1">
          <a href="tel:+56123456789" class="flex items-center space-x-2 text-xs text-gray-700 hover:text-accent-800 transition-colors">
            <Phone size="12" />
            <span>+56 (2) 1234 5678</span>
          </a>
          <a href="mailto:info@cmsconsultores.cl" class="flex items-center space-x-2 text-xs text-gray-700 hover:text-accent-800 transition-colors">
            <Mail size="12" />
            <span>info@cmsconsultores.cl</span>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';
  
  // Esperar a que el DOM esté completamente cargado
  function initWidget() {
    const messageButton = document.getElementById('message-button');
    const messagePanel = document.getElementById('message-panel');
    const closePanel = document.getElementById('close-panel');
    const messageForm = document.getElementById('message-form');

    console.log('Inicializando widget...', {
      messageButton: !!messageButton,
      messagePanel: !!messagePanel,
      closePanel: !!closePanel,
      messageForm: !!messageForm
    });

    if (!messageButton || !messagePanel) {
      console.error('Elementos del widget no encontrados');
      return;
    }

    // Función para mostrar/ocultar el panel
    function togglePanel() {
      console.log('Toggle panel clicked');
      if (!messagePanel || !messageButton) return;
      
      const isHidden = messagePanel.classList.contains('hidden');
      
      if (isHidden) {
        // Verificar el espacio disponible y ajustar posición si es necesario
        const rect = messageButton.getBoundingClientRect();
        const windowHeight = window.innerHeight;
        const panelHeight = 300; // Altura aproximada del panel reducido
        
        // Si no hay suficiente espacio arriba, mantener el panel hacia arriba pero ajustar
        if (rect.top < panelHeight) {
          messagePanel.style.maxHeight = Math.min(rect.top - 20, 250) + 'px';
        } else {
          messagePanel.style.maxHeight = '300px';
        }
        
        messagePanel.classList.remove('hidden');
        console.log('Panel mostrado');
        
        // Scroll al top del panel si es necesario
        setTimeout(() => {
          if (messagePanel) {
            messagePanel.scrollTop = 0;
          }
        }, 50);
      } else {
        messagePanel.classList.add('hidden');
        console.log('Panel oculto');
      }
    }

    // Función para ocultar el panel
    function hidePanel() {
      console.log('Ocultando panel');
      if (messagePanel) {
        messagePanel.classList.add('hidden');
      }
    }

    // Event listeners
    messageButton.addEventListener('click', function(event) {
      event.preventDefault();
      event.stopPropagation();
      console.log('Botón clickeado');
      togglePanel();
    });

    if (closePanel) {
      closePanel.addEventListener('click', function(event) {
        event.preventDefault();
        event.stopPropagation();
        console.log('Botón cerrar clickeado');
        hidePanel();
      });
    }

    // Cerrar al hacer click fuera
    document.addEventListener('click', function(event) {
      const widget = document.getElementById('message-widget');
      const target = event.target as Node;
      if (widget && target && !widget.contains(target)) {
        hidePanel();
      }
    });

    // Manejar envío del formulario
    if (messageForm) {
      messageForm.addEventListener('submit', function(event) {
        event.preventDefault();
        console.log('Formulario enviado');
        
        const form = messageForm as HTMLFormElement;
        const formData = new FormData(form);
        const name = formData.get('name');
        const email = formData.get('email');
        const message = formData.get('message');
        
        console.log('Datos del formulario:', { name, email, message });
        
        alert('¡Gracias por tu mensaje! Te contactaremos pronto.');
        
        // Reset form usando el casting correcto
        (messageForm as HTMLFormElement).reset();
        hidePanel();
      });
    }
  }

  // Inicializar cuando el DOM esté listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initWidget);
  } else {
    initWidget();
  }
})();
</script>

<style>
  /* Asegurar que el widget esté por encima de otros elementos */
  #message-widget {
    z-index: 9999 !important;
  }
  
  /* Botón flotante */
  #message-button {
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
  }
  
  #message-button:hover {
    transform: scale(1.05);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
  }
  
  /* Panel del formulario */
  #message-panel {
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
    transform-origin: bottom right;
  }
  
  #message-panel.hidden {
    display: none !important;
    opacity: 0;
  }
  
  #message-panel:not(.hidden) {
    display: block !important;
    opacity: 1;
    animation: slideInUp 0.3s ease-out;
  }
  
  /* Animaciones - ahora desde abajo hacia arriba */
  @keyframes slideInUp {
    from {
      opacity: 0;
      transform: translateY(10px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
  
  /* Ajustes responsive mejorados para formulario con mejor ancho */
  @media (min-width: 1024px) {
    #message-panel {
      width: 384px !important; /* Aproximadamente 4cm más ancho que el original en desktop */
    }
  }
  
  @media (max-width: 768px) {
    #message-widget {
      right: 8px !important;
      bottom: 8px !important;
    }
    
    #message-panel {
      width: calc(100vw - 16px) !important;
      max-width: 280px !important;
      right: -8px !important;
      max-height: 50vh !important;
    }
  }
  
  @media (max-width: 480px) {
    #message-panel {
      width: calc(100vw - 12px) !important;
      right: -4px !important;
      max-height: 45vh !important;
    }
  }
  
  /* Ajuste para pantallas muy pequeñas en altura */
  @media (max-height: 600px) {
    #message-widget {
      bottom: 4px !important;
    }
    
    #message-panel {
      max-height: 40vh !important;
    }
  }
  
  @media (max-height: 500px) {
    #message-panel {
      max-height: 35vh !important;
    }
  }
  
  /* Asegurar que los elementos sean clickeables */
  #message-button {
    pointer-events: all;
    user-select: none;
  }
  
  /* Estilos para el formulario */
  #message-form input:focus,
  #message-form textarea:focus {
    ring-offset-width: 2px;
  }
  
  /* Asegurar scroll suave en el panel */
  #message-panel {
    scrollbar-width: thin;
    scrollbar-color: rgba(156, 163, 175, 0.5) transparent;
  }
  
  #message-panel::-webkit-scrollbar {
    width: 6px;
  }
  
  #message-panel::-webkit-scrollbar-track {
    background: transparent;
  }
  
  #message-panel::-webkit-scrollbar-thumb {
    background-color: rgba(156, 163, 175, 0.5);
    border-radius: 3px;
  }
</style>
